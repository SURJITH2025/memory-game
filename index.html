<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip Match - Multiplayer Memory Game</title>
    <meta property="og:title" content="Flip Match - Memory Game Challenge">
    <meta property="og:description" content="Join me in Flip Match! Test your memory in solo or multiplayer mode.">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/0a0e27/00ffff?text=Flip+Match">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');

        /* NEON CYBERPUNK THEME */
        body { 
            background: #0a0e27 !important; 
            font-family: 'Orbitron', sans-serif !important;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: ''; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(120, 0, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%);
            animation: bgPulse 15s ease-in-out infinite; 
            pointer-events: none; 
            z-index: -1;
        }
        
        @keyframes bgPulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        
        h1 { 
            background: linear-gradient(135deg, #00ffff, #ff00ff, #00ffff) !important;
            -webkit-background-clip: text !important; 
            -webkit-text-fill-color: transparent !important;
            filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.5)) !important;
            font-weight: 900 !important; 
            letter-spacing: 3px !important;
            font-size: clamp(32px, 6vw, 56px);
            margin-bottom: 10px;
            text-transform: uppercase;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 0, 255, 0.8)); }
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .stat-badge {
            background: rgba(10, 14, 39, 0.8) !important; 
            color: #00ffff !important;
            border: 2px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .stat-badge:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .stat-badge.pulse {
            animation: neonPulse 2s infinite;
        }

        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
        }

        .live-stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: rgba(10, 14, 39, 0.9) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3) !important;
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }
        
        .info-label { 
            color: #00ffff !important; 
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .game-info {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .game-board {
            background: rgba(10, 14, 39, 0.5) !important;
            border: 2px solid rgba(0, 255, 255, 0.2) !important;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.2) !important;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            perspective: 1000px;
        }

        .card {
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            animation: matchPulse 0.6s ease;
        }

        @keyframes matchPulse {
            0%, 100% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: clamp(32px, 6vw, 48px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card-front {
            background: linear-gradient(135deg, #1a1a2e, #16213e) !important;
            border: 3px solid #00ffff !important;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4) !important;
            transform: rotateY(180deg);
        }
        
        .card-back {
            background: linear-gradient(135deg, #0f3460, #16213e) !important;
            color: #00ffff !important; 
            border: 3px solid rgba(0, 255, 255, 0.5) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8) !important;
            font-weight: bold;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: 'Orbitron', sans-serif;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff00ff, #00ffff) !important;
            border: 2px solid #ff00ff !important;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5) !important;
            color: white !important;
        }
        
        .btn-primary:hover { 
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.8) !important; 
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(10, 14, 39, 0.8) !important; 
            color: #00ffff !important;
            border: 2px solid #00ffff !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
        }
        
        .btn-secondary:hover { 
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.6) !important; 
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00ffff) !important;
            color: #0a0e27 !important; 
            border: 2px solid #00ff88 !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5) !important;
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #0f3460, #16213e) !important;
            border: 3px solid rgba(0, 255, 255, 0.4) !important;
            box-shadow: 0 0 60px rgba(0, 255, 255, 0.4) !important;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 { 
            color: #00ffff !important; 
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8) !important; 
            margin-bottom: 20px;
            font-size: 32px;
            text-align: center;
        }
        
        .modal p { 
            color: #fff !important; 
            margin-bottom: 10px;
            font-size: 18px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00ffff !important;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(0, 255, 255, 0.3) !important;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: rgba(10, 14, 39, 0.8) !important; 
            color: white !important;
            font-family: 'Orbitron', sans-serif !important;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ffff !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4) !important;
        }

        .error-message { 
            color: #ff00ff !important; 
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.8) !important; 
            font-size: 14px;
            margin-top: 5px;
        }

        .user-info {
            background: rgba(10, 14, 39, 0.8) !important;
            border: 2px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-name { 
            color: #00ffff !important; 
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5) !important; 
            font-weight: 600;
            font-size: 18px;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 16px;
            border: 2px solid rgba(0, 255, 255, 0.3);
            background: rgba(10, 14, 39, 0.8);
            color: #00ffff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ff00ff, #00ffff);
            color: white;
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }

        .leaderboard-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .leaderboard-item {
            background: rgba(10, 14, 39, 0.5) !important;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2) !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            transition: background 0.2s;
        }

        .leaderboard-item:hover {
            background: rgba(0, 255, 255, 0.1) !important;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2) !important;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank { 
            color: #00ffff !important; 
            font-weight: bold;
            width: 40px;
        }
        
        .rank.gold { 
            color: #FFD700 !important; 
            text-shadow: 0 0 15px #FFD700 !important; 
        }
        
        .rank.silver { 
            color: #C0C0C0 !important; 
            text-shadow: 0 0 15px #C0C0C0 !important; 
        }
        
        .rank.bronze { 
            color: #CD7F32 !important; 
            text-shadow: 0 0 15px #CD7F32 !important; 
        }

        .player-name { 
            color: white !important; 
            flex: 1;
            font-weight: 600;
        }

        .score { 
            color: #00ffff !important; 
            font-size: 14px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e) !important;
            border: 2px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2) !important;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value { 
            color: #00ffff !important; 
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.8) !important; 
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .hidden {
            display: none !important;
        }

        .welcome-screen {
            text-align: center;
            color: white;
        }

        .welcome-screen h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #00ffff;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
        }

        .welcome-screen p {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .mode-selection {
            max-width: 1200px;
            margin: 0 auto;
        }

        .mode-selection h2 {
            color: #00ffff;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .mode-card {
            background: linear-gradient(135deg, #0f3460, #16213e) !important;
            border: 3px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2) !important;
            border-radius: 16px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5) !important;
            border-color: #00ffff !important;
            transform: translateY(-8px);
        }

        .mode-icon {
            font-size: 64px;
            margin-bottom: 15px;
            text-align: center;
        }

        .mode-card h3 { 
            color: #00ffff !important; 
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.6) !important; 
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }

        .mode-description { 
            color: #fff !important; 
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
            min-height: 60px;
        }

        .mode-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 15px;
            border-top: 2px solid rgba(0, 255, 255, 0.2);
        }

        .mode-details span { 
            color: #00ffff !important; 
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .level-info {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-badge, .level-badge {
            background: rgba(10, 14, 39, 0.9) !important; 
            color: #00ffff !important;
            border: 2px solid rgba(0, 255, 255, 0.4) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .level-badge {
            background: linear-gradient(135deg, #ff00ff, #00ffff) !important;
            color: white !important; 
            border-color: #ff00ff !important;
        }

        /* Multiplayer specific styles */
        .room-code-display {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .room-code {
            font-size: 36px;
            font-weight: bold;
            color: #00ffff;
            letter-spacing: 8px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            margin: 10px 0;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .player-item {
            background: rgba(10, 14, 39, 0.5);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item.host {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .matchmaking-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top-color: #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .vs-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
        }

        .player-card {
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-width: 150px;
        }

        .player-card.winner {
            border-color: #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .share-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .mode-cards {
                grid-template-columns: 1fr;
            }
            
            .mode-card {
                padding: 20px;
            }
            
            .mode-icon {
                font-size: 48px;
            }

            .room-code {
                font-size: 28px;
                letter-spacing: 4px;
            }
        }

        @media (max-width: 600px) {
            .game-board {
                gap: 8px;
            }

            .card-face {
                border-radius: 8px;
            }

            .info-box {
                padding: 10px 20px;
                font-size: 16px;
            }

            button {
                padding: 12px 24px;
                font-size: 14px;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="welcome-screen">
            <h2>üé¥ Flip Match</h2>
            <p>Compete globally, play with friends, and track your progress!</p>
            <div class="controls">
                <button class="btn-primary" onclick="app.showLogin()">Login</button>
                <button class="btn-success" onclick="app.showRegister()">Create Account</button>
                <button class="btn-secondary" onclick="app.playAsGuest()">üéÆ Play as Guest</button>
                <button class="btn-secondary" onclick="app.viewStats()">üìä View Stats</button>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden">
            <header>
                <h1>üé¥ Flip Match</h1>
            </header>

            <div class="live-stats">
                <div class="stat-badge pulse">
                    üë• <span id="onlineUsers">0</span> Online
                </div>
                <div class="stat-badge">
                    üìä <span id="totalPlayers">0</span> Total Players
                </div>
                <div class="stat-badge">
                    üéÆ <span id="gamesPlayed">0</span> Games Played
                </div>
                <div class="stat-badge">
                    ‚öîÔ∏è <span id="multiplayerMatches">0</span> Multiplayer
                </div>
            </div>

            <div class="user-info" id="userInfo">
                <div>
                    <span class="user-name" id="displayName"></span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-success" id="upgradeBtn" style="padding: 8px 16px; display: none;" onclick="app.showUpgrade()">‚¨ÜÔ∏è Upgrade</button>
                    <button class="btn-secondary" style="padding: 8px 16px;" onclick="app.logout()">Logout</button>
                </div>
            </div>

            <!-- Mode Selection -->
            <div id="modeSelection" class="mode-selection">
                <h2 style="text-align: center; margin-bottom: 30px;">Choose Your Challenge</h2>
                
                <!-- Solo/Multiplayer Toggle -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 30px;">
                    <button class="tab-btn active" id="soloTab" onclick="app.switchGameType('solo')">üë§ Solo</button>
                    <button class="tab-btn" id="multiTab" onclick="app.switchGameType('multiplayer')">‚öîÔ∏è Multiplayer</button>
                </div>

                <!-- Solo Modes -->
                <div id="soloModes" class="mode-cards">
                    <div class="mode-card" onclick="app.selectMode('classic')">
                        <div class="mode-icon">üéØ</div>
                        <h3>Classic Mode</h3>
                        <p class="mode-description">No pressure! Take your time and find all pairs.</p>
                        <div class="mode-details">
                            <span>‚úì Unlimited moves</span>
                            <span>‚úì No lives system</span>
                            <span>‚úì Pure memory test</span>
                        </div>
                    </div>
                    
                    <div class="mode-card" onclick="app.selectMode('timed')">
                        <div class="mode-icon">‚è±Ô∏è</div>
                        <h3>Move Limit Mode</h3>
                        <p class="mode-description">Beat each level within the move limit!</p>
                        <div class="mode-details">
                            <span>üìä Limited moves</span>
                            <span>üìà Harder levels</span>
                            <span>üéØ Efficiency bonus</span>
                        </div>
                    </div>
                    
                    <div class="mode-card" onclick="app.selectMode('hardcore')">
                        <div class="mode-icon">üíÄ</div>
                        <h3>Lives Mode</h3>
                        <p class="mode-description">Limited lives! Wrong matches cost hearts!</p>
                        <div class="mode-details">
                            <span>‚ù§Ô∏è 3-5 lives</span>
                            <span>üíî Wrong = -1 life</span>
                            <span>üî• Expert mode</span>
                        </div>
                    </div>
                </div>

                <!-- Multiplayer Modes -->
                <div id="multiplayerModes" class="mode-cards hidden">
                    <div class="mode-card" onclick="app.createRoom()">
                        <div class="mode-icon">üéÆ</div>
                        <h3>Create Room</h3>
                        <p class="mode-description">Create a game and invite friends with a code!</p>
                        <div class="mode-details">
                            <span>üîë Unique room code</span>
                            <span>üë• Invite friends</span>
                            <span>‚öôÔ∏è Custom settings</span>
                        </div>
                    </div>
                    
                    <div class="mode-card" onclick="app.showJoinRoom()">
                        <div class="mode-icon">üö™</div>
                        <h3>Join Room</h3>
                        <p class="mode-description">Enter a code to join your friend's game!</p>
                        <div class="mode-details">
                            <span>üî¢ Enter code</span>
                            <span>üë• Play together</span>
                            <span>‚ö° Instant join</span>
                        </div>
                    </div>
                    
                    <div class="mode-card" onclick="app.quickMatch()">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <h3>Quick Match</h3>
                        <p class="mode-description">Jump into a 1v1 with a random opponent!</p>
                        <div class="mode-details">
                            <span>üé≤ Random match</span>
                            <span>‚ö° Fast start</span>
                            <span>üèÜ Competitive</span>
                        </div>
                    </div>
                </div>

                <button class="btn-secondary" style="margin-top: 20px;" onclick="app.backToWelcome()">‚Üê Back</button>
            </div>

            <!-- Room Lobby -->
            <div id="roomLobby" class="hidden" style="text-align: center; color: white;">
                <h2 style="margin-bottom: 20px;">Game Room</h2>
                
                <div class="room-code-display">
                    <div style="font-size: 18px; color: #00ffff; margin-bottom: 10px;">Room Code:</div>
                    <div class="room-code" id="displayRoomCode">ABCD</div>
                    <button class="btn-secondary" style="margin-top: 10px;" onclick="app.copyRoomCode()">üìã Copy Code</button>
                    <button class="btn-secondary" style="margin-top: 10px;" onclick="app.shareRoomLink()">üîó Share Link</button>
                </div>

                <div class="player-list" id="playerListContainer"></div>

                <div class="controls">
                    <button class="btn-primary" id="startGameBtn" onclick="app.startMultiplayerGame()" style="display: none;">üéÆ Start Game</button>
                    <button class="btn-secondary" onclick="app.leaveRoom()">‚Üê Leave Room</button>
                </div>
            </div>

            <!-- Game Play -->
            <div id="gamePlay" class="hidden">
                <div class="level-info">
                    <div class="mode-badge" id="modeBadge">Classic Mode</div>
                    <div class="level-badge" id="levelBadge">Level 1</div>
                </div>

                <!-- Multiplayer Scores -->
                <div id="multiplayerScores" class="hidden">
                    <div class="vs-display">
                        <div class="player-card" id="player1Card">
                            <div class="user-name" id="player1Name">Player 1</div>
                            <div class="stat-value" id="player1Score">0</div>
                            <div class="stat-label">Pairs</div>
                        </div>
                        <div style="font-size: 48px; color: #ff00ff;">‚öîÔ∏è</div>
                        <div class="player-card" id="player2Card">
                            <div class="user-name" id="player2Name">Player 2</div>
                            <div class="stat-value" id="player2Score">0</div>
                            <div class="stat-label">Pairs</div>
                        </div>
                    </div>
                </div>

                <div class="game-info">
                    <div class="info-box">
                        <div class="info-label">Level</div>
                        <div id="currentLevel">1</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Score</div>
                        <div id="totalScore">0</div>
                    </div>
                    <div class="info-box" id="movesBox">
                        <div class="info-label">Moves</div>
                        <div id="moves">0</div>
                    </div>
                    <div class="info-box" id="livesBox" style="display: none;">
                        <div class="info-label">Lives</div>
                        <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Time</div>
                        <div id="timer">0:00</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Pairs</div>
                        <div id="pairs">0/6</div>
                    </div>
                </div>

                <div class="game-board" id="gameBoard"></div>

                <div class="controls">
                    <button class="btn-primary" onclick="game.restartLevel()">üîÑ Restart</button>
                    <button class="btn-secondary" onclick="app.showLeaderboard()">üèÜ Leaderboard</button>
                    <button class="btn-secondary" onclick="app.quitToMenu()">üè† Menu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2>Login</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <div id="loginError" class="error-message"></div>
            <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="app.login()">Login</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.closeModal('loginModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2>Create Account</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="registerUsername" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="Your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="Choose password">
            </div>
            <div id="registerError" class="error-message"></div>
            <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="app.register()">Create Account</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.closeModal('registerModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="upgradeModal">
        <div class="modal-content">
            <h2>‚¨ÜÔ∏è Upgrade Account</h2>
            <p style="margin-bottom: 20px;">Save progress and compete with a custom username!</p>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="upgradeUsername" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="upgradeEmail" placeholder="Your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="upgradePassword" placeholder="Choose password">
            </div>
            <div id="upgradeError" class="error-message"></div>
            <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="app.upgradeAccount()">Upgrade</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.closeModal('upgradeModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="joinRoomModal">
        <div class="modal-content">
            <h2>üö™ Join Room</h2>
            <div class="form-group">
                <label>Room Code</label>
                <input type="text" id="joinRoomCode" placeholder="Enter 4-letter code" maxlength="4" style="text-transform: uppercase; text-align: center; font-size: 24px; letter-spacing: 4px;">
            </div>
            <div id="joinRoomError" class="error-message"></div>
            <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="app.joinRoom()">Join Game</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.closeModal('joinRoomModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="matchmakingModal">
        <div class="modal-content">
            <h2>‚öîÔ∏è Finding Opponent...</h2>
            <div class="matchmaking-spinner"></div>
            <p>Searching for a worthy challenger...</p>
            <button class="btn-secondary" style="width: 100%; margin-top: 20px;" onclick="app.cancelMatchmaking()">Cancel</button>
        </div>
    </div>

    <div class="modal" id="winModal">
        <div class="modal-content">
            <h2>üéâ Level Complete!</h2>
            <p>Level: <strong id="completedLevel">1</strong></p>
            <p>Moves: <strong id="finalMoves">0</strong></p>
            <p>Time: <strong id="finalTime">0:00</strong></p>
            <p>Level Score: <strong id="levelScore">0</strong></p>
            <p style="font-size: 24px;">Total: <strong id="displayTotalScore">0</strong></p>
            <div class="share-options">
                <button class="btn-secondary" onclick="app.shareScore('twitter')">üê¶ Tweet</button>
                <button class="btn-secondary" onclick="app.shareScore('facebook')">üìò Share</button>
                <button class="btn-secondary" onclick="app.copyScoreLink()">üîó Copy</button>
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="game.nextLevel()">‚û°Ô∏è Next Level</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.quitToMenu()">üè† Menu</button>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2>üíî Game Over</h2>
            <p id="gameOverReason">You ran out of lives!</p>
            <p>Level: <strong id="finalLevel">1</strong></p>
            <p>Score: <strong id="gameOverScore">0</strong></p>
            <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="game.retryLevel()">üîÑ Retry</button>
            <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="app.selectMode(app.currentMode)">üîÑ Restart</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.quitToMenu()">üè† Menu</button>
        </div>
    </div>

    <div class="modal" id="victoryModal">
        <div class="modal-content">
            <h2>üèÜ VICTORY!</h2>
            <p style="font-size: 20px; margin-bottom: 20px;">All levels complete!</p>
            <p>Score: <strong id="victoryScore" style="font-size: 32px;">0</strong></p>
            <p>Time: <strong id="victoryTime">0:00</strong></p>
            <p>Moves: <strong id="victoryMoves">0</strong></p>
            <div class="share-options">
                <button class="btn-secondary" onclick="app.shareScore('twitter')">üê¶ Tweet</button>
                <button class="btn-secondary" onclick="app.shareScore('facebook')">üìò Share</button>
                <button class="btn-secondary" onclick="app.copyScoreLink()">üîó Copy</button>
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="app.showLeaderboard()">üèÜ Leaderboard</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.quitToMenu()">üè† Menu</button>
        </div>
    </div>

    <div class="modal" id="multiplayerVictoryModal">
        <div class="modal-content">
            <h2 id="multiWinTitle">üèÜ Victory!</h2>
            <div class="vs-display" style="margin: 20px 0;">
                <div class="player-card" id="finalPlayer1Card">
                    <div class="user-name" id="finalPlayer1Name">You</div>
                    <div class="stat-value" id="finalPlayer1Score">0</div>
                    <div class="stat-label">Pairs</div>
                </div>
                <div style="font-size: 48px; color: #ff00ff;">VS</div>
                <div class="player-card" id="finalPlayer2Card">
                    <div class="user-name" id="finalPlayer2Name">Opponent</div>
                    <div class="stat-value" id="finalPlayer2Score">0</div>
                    <div class="stat-label">Pairs</div>
                </div>
            </div>
            <div class="share-options">
                <button class="btn-secondary" onclick="app.shareMultiplayerResult()">üîó Share Result</button>
                <button class="btn-secondary" onclick="app.rematch()">üîÑ Rematch</button>
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="app.showLeaderboard()">üèÜ Leaderboard</button>
            <button class="btn-secondary" style="width: 100%;" onclick="app.quitToMenu()">üè† Menu</button>
        </div>
    </div>

    <div class="modal" id="leaderboardModal">
        <div class="modal-content">
            <h2>üèÜ Leaderboard</h2>
            <div class="leaderboard-tabs">
                <button class="tab-btn active" onclick="app.switchLeaderboard('daily')">Today</button>
                <button class="tab-btn" onclick="app.switchLeaderboard('weekly')">Week</button>
                <button class="tab-btn" onclick="app.switchLeaderboard('alltime')">All Time</button>
            </div>
            <div class="leaderboard-tabs" style="margin-top: 10px;">
                <button class="tab-btn mode-filter active" data-mode="classic" onclick="app.filterByMode('classic')">üéØ Classic</button>
                <button class="tab-btn mode-filter" data-mode="timed" onclick="app.filterByMode('timed')">‚è±Ô∏è Moves</button>
                <button class="tab-btn mode-filter" data-mode="hardcore" onclick="app.filterByMode('hardcore')">üíÄ Lives</button>
                <button class="tab-btn mode-filter" data-mode="multiplayer" onclick="app.filterByMode('multiplayer')">‚öîÔ∏è Multi</button>
            </div>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="btn-secondary" style="width: 100%; margin-top: 20px;" onclick="app.closeModal('leaderboardModal')">Close</button>
        </div>
    </div>

    <div class="modal" id="globalStatsModal">
        <div class="modal-content">
            <h2>üìä Global Stats</h2>
            <div class="stats-grid" id="globalStatsGrid"></div>
            <button class="btn-secondary" style="width: 100%; margin-top: 20px;" onclick="app.closeModal('globalStatsModal')">Close</button>
        </div>
    </div>

    <script>
        // Application State
        const app = {
            currentUser: null,
            currentLeaderboard: 'daily',
            currentMode: null,
            currentModeFilter: 'classic',
            sessionId: null,
            gameType: 'solo',
            currentRoom: null,
            isHost: false,
            matchmakingTimeout: null,
            roomPollInterval: null,

            async init() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                await this.registerOnlineUser();
                setInterval(() => this.updateLiveStats(), 30000);
                
                const savedUser = localStorage.getItem('flipMatchUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showGameScreen();
                } else {
                    const guestId = localStorage.getItem('flipMatchGuestId');
                    if (guestId) {
                        this.currentUser = {
                            username: 'Guest_' + guestId,
                            isGuest: true,
                            guestId: guestId,
                            createdAt: Date.now()
                        };
                        localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                        this.showGameScreen();
                    }
                }
                
                await this.updateLiveStats();
                window.addEventListener('beforeunload', () => this.unregisterOnlineUser());

                // Check for room code in URL
                const urlParams = new URLSearchParams(window.location.search);
                const roomCode = urlParams.get('room');
                if (roomCode && this.currentUser) {
                    this.switchGameType('multiplayer');
                    document.getElementById('joinRoomCode').value = roomCode.toUpperCase();
                    setTimeout(() => this.showJoinRoom(), 500);
                }
            },

            switchGameType(type) {
                this.gameType = type;
                document.getElementById('soloTab').classList.toggle('active', type === 'solo');
                document.getElementById('multiTab').classList.toggle('active', type === 'multiplayer');
                document.getElementById('soloModes').classList.toggle('hidden', type !== 'solo');
                document.getElementById('multiplayerModes').classList.toggle('hidden', type !== 'multiplayer');
            },

            playAsGuest() {
                let guestId = localStorage.getItem('flipMatchGuestId');
                if (!guestId) {
                    guestId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    localStorage.setItem('flipMatchGuestId', guestId);
                }
                this.currentUser = {
                    username: 'Guest_' + guestId,
                    isGuest: true,
                    guestId: guestId,
                    createdAt: Date.now()
                };
                localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                this.showGameScreen();
            },

            showUpgrade() {
                document.getElementById('upgradeModal').classList.add('active');
            },

            async upgradeAccount() {
                if (!this.currentUser || !this.currentUser.isGuest) return;

                const username = document.getElementById('upgradeUsername').value.trim();
                const email = document.getElementById('upgradeEmail').value.trim();
                const password = document.getElementById('upgradePassword').value;

                if (!username || !email || !password) {
                    document.getElementById('upgradeError').textContent = 'Fill all fields';
                    return;
                }

                if (username.length < 3) {
                    document.getElementById('upgradeError').textContent = 'Username too short';
                    return;
                }

                try {
                    const userKey = 'user:' + username.toLowerCase();
                    const userData = {
                        username: username,
                        email: email,
                        password: password,
                        createdAt: Date.now(),
                        upgradedFrom: this.currentUser.username
                    };

                    await window.storage.set(userKey, JSON.stringify(userData), true);

                    this.currentUser = {
                        username: username,
                        email: email,
                        isGuest: false,
                        createdAt: Date.now()
                    };

                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    localStorage.removeItem('flipMatchGuestId');
                    this.closeModal('upgradeModal');
                    document.getElementById('displayName').textContent = `üë§ ${username}`;
                    document.getElementById('upgradeBtn').style.display = 'none';
                    alert('üéâ Account upgraded!');
                } catch (error) {
                    alert('Upgrade successful!');
                    this.currentUser = { username, email, isGuest: false };
                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    this.closeModal('upgradeModal');
                }
            },

            async registerOnlineUser() {
                try {
                    await window.storage.set('online:' + this.sessionId, Date.now().toString(), true);
                } catch (e) {}
            },

            async unregisterOnlineUser() {
                try {
                    await window.storage.delete('online:' + this.sessionId, true);
                } catch (e) {}
            },

            async updateLiveStats() {
                try {
                    const onlineList = await window.storage.list('online:', true);
                    let activeCount = 0;
                    const now = Date.now();
                    
                    if (onlineList && onlineList.keys) {
                        for (const key of onlineList.keys) {
                            try {
                                const data = await window.storage.get(key, true);
                                if (data && now - parseInt(data.value) < 300000) {
                                    activeCount++;
                                }
                            } catch (e) {}
                        }
                    }
                    
                    document.getElementById('onlineUsers').textContent = activeCount;

                    const usersList = await window.storage.list('user:', true);
                    document.getElementById('totalPlayers').textContent = usersList && usersList.keys ? usersList.keys.length : 0;

                    const gamesPlayed = await window.storage.get('stats:gamesplayed', true);
                    document.getElementById('gamesPlayed').textContent = gamesPlayed ? gamesPlayed.value : '0';

                    const multiMatches = await window.storage.get('stats:multimatches', true);
                    document.getElementById('multiplayerMatches').textContent = multiMatches ? multiMatches.value : '0';
                } catch (error) {}
            },

            showLogin() {
                document.getElementById('loginModal').classList.add('active');
            },

            showRegister() {
                document.getElementById('registerModal').classList.add('active');
            },

            async login() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    document.getElementById('loginError').textContent = 'Fill all fields';
                    return;
                }

                try {
                    const userData = await window.storage.get('user:' + username.toLowerCase(), true);
                    if (!userData) {
                        document.getElementById('loginError').textContent = 'User not found';
                        return;
                    }

                    const user = JSON.parse(userData.value);
                    if (user.password !== password) {
                        document.getElementById('loginError').textContent = 'Wrong password';
                        return;
                    }

                    this.currentUser = {
                        username: user.username,
                        email: user.email,
                        createdAt: user.createdAt
                    };

                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    this.closeModal('loginModal');
                    this.showGameScreen();
                } catch (error) {
                    // Demo mode
                    this.currentUser = { username };
                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    this.closeModal('loginModal');
                    this.showGameScreen();
                }
            },

            async register() {
                const username = document.getElementById('registerUsername').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;

                if (!username || !email || !password) {
                    document.getElementById('registerError').textContent = 'Fill all fields';
                    return;
                }

                if (username.length < 3) {
                    document.getElementById('registerError').textContent = 'Username too short';
                    return;
                }

                try {
                    const userData = {
                        username,
                        email,
                        password,
                        createdAt: Date.now()
                    };

                    await window.storage.set('user:' + username.toLowerCase(), JSON.stringify(userData), true);

                    this.currentUser = {
                        username: userData.username,
                        email: userData.email,
                        createdAt: userData.createdAt
                    };

                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    this.closeModal('registerModal');
                    this.showGameScreen();
                } catch (error) {
                    // Demo mode
                    this.currentUser = { username, email };
                    localStorage.setItem('flipMatchUser', JSON.stringify(this.currentUser));
                    this.closeModal('registerModal');
                    this.showGameScreen();
                }
            },

            logout() {
                localStorage.removeItem('flipMatchUser');
                if (!this.currentUser || !this.currentUser.isGuest) {
                    localStorage.removeItem('flipMatchGuestId');
                }
                this.currentUser = null;
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            },

            showGameScreen() {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                document.getElementById('modeSelection').classList.remove('hidden');
                document.getElementById('gamePlay').classList.add('hidden');
                document.getElementById('roomLobby').classList.add('hidden');
                
                const displayName = this.currentUser.isGuest 
                    ? `üéÆ ${this.currentUser.username}` 
                    : `üë§ ${this.currentUser.username}`;
                document.getElementById('displayName').textContent = displayName;
                
                document.getElementById('upgradeBtn').style.display = this.currentUser.isGuest ? 'block' : 'none';
                this.updateLiveStats();
            },

            selectMode(mode) {
                this.currentMode = mode;
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('gamePlay').classList.remove('hidden');
                document.getElementById('multiplayerScores').classList.add('hidden');
                
                const modeNames = {
                    'classic': 'üéØ Classic',
                    'timed': '‚è±Ô∏è Move Limit',
                    'hardcore': 'üíÄ Lives'
                };
                document.getElementById('modeBadge').textContent = modeNames[mode];
                game.init(mode, false);
            },

            // Multiplayer functions
            async createRoom() {
                const code = this.generateRoomCode();
                const roomData = {
                    code: code,
                    host: this.currentUser.username,
                    players: [this.currentUser.username],
                    status: 'waiting',
                    createdAt: Date.now()
                };

                try {
                    await window.storage.set('room:' + code, JSON.stringify(roomData), true);
                } catch (e) {}

                this.currentRoom = roomData;
                this.isHost = true;
                this.showRoomLobby();
                this.startRoomPolling();
            },

            generateRoomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let code = '';
                for (let i = 0; i < 4; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            },

            showJoinRoom() {
                document.getElementById('joinRoomModal').classList.add('active');
                document.getElementById('joinRoomCode').value = '';
            },

            async joinRoom() {
                const code = document.getElementById('joinRoomCode').value.trim().toUpperCase();
                
                if (code.length !== 4) {
                    document.getElementById('joinRoomError').textContent = 'Enter 4-letter code';
                    return;
                }

                try {
                    const roomData = await window.storage.get('room:' + code, true);
                    if (!roomData) {
                        document.getElementById('joinRoomError').textContent = 'Room not found';
                        return;
                    }

                    const room = JSON.parse(roomData.value);
                    if (room.players.length >= 2) {
                        document.getElementById('joinRoomError').textContent = 'Room full';
                        return;
                    }

                    room.players.push(this.currentUser.username);
                    await window.storage.set('room:' + code, JSON.stringify(room), true);

                    this.currentRoom = room;
                    this.isHost = false;
                    this.closeModal('joinRoomModal');
                    this.showRoomLobby();
                    this.startRoomPolling();
                } catch (error) {
                    // Demo mode
                    this.currentRoom = {
                        code: code,
                        host: 'Host',
                        players: ['Host', this.currentUser.username],
                        status: 'waiting'
                    };
                    this.isHost = false;
                    this.closeModal('joinRoomModal');
                    this.showRoomLobby();
                }
            },

            showRoomLobby() {
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('roomLobby').classList.remove('hidden');
                document.getElementById('displayRoomCode').textContent = this.currentRoom.code;
                document.getElementById('startGameBtn').style.display = this.isHost ? 'block' : 'none';
                this.updatePlayerList();
            },

            updatePlayerList() {
                const container = document.getElementById('playerListContainer');
                container.innerHTML = '';
                
                this.currentRoom.players.forEach(player => {
                    const isHost = player === this.currentRoom.host;
                    const div = document.createElement('div');
                    div.className = 'player-item' + (isHost ? ' host' : '');
                    div.innerHTML = `
                        <span style="color: white; font-weight: 600;">
                            ${isHost ? 'üëë ' : 'üë§ '}${player}
                        </span>
                        <span style="color: #00ffff;">${isHost ? 'Host' : 'Player'}</span>
                    `;
                    container.appendChild(div);
                });

                if (this.currentRoom.players.length < 2) {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = '<span style="color: #666;">Waiting...</span>';
                    container.appendChild(div);
                }
            },

            async startRoomPolling() {
                this.roomPollInterval = setInterval(async () => {
                    if (!this.currentRoom) {
                        clearInterval(this.roomPollInterval);
                        return;
                    }

                    try {
                        const roomData = await window.storage.get('room:' + this.currentRoom.code, true);
                        if (roomData) {
                            this.currentRoom = JSON.parse(roomData.value);
                            this.updatePlayerList();

                            if (this.currentRoom.status === 'playing' && !this.isHost) {
                                clearInterval(this.roomPollInterval);
                                this.startMultiplayerGame();
                            }
                        }
                    } catch (e) {}
                }, 2000);
            },

            async startMultiplayerGame() {
                if (this.isHost) {
                    this.currentRoom.status = 'playing';
                    try {
                        await window.storage.set('room:' + this.currentRoom.code, JSON.stringify(this.currentRoom), true);
                    } catch (e) {}
                }

                clearInterval(this.roomPollInterval);
                
                document.getElementById('roomLobby').classList.add('hidden');
                document.getElementById('gamePlay').classList.remove('hidden');
                document.getElementById('multiplayerScores').classList.remove('hidden');
                
                document.getElementById('player1Name').textContent = this.currentRoom.players[0];
                document.getElementById('player2Name').textContent = this.currentRoom.players[1];
                
                game.init('multiplayer', true, this.currentRoom);
            },

            async quickMatch() {
                document.getElementById('matchmakingModal').classList.add('active');
                
                this.matchmakingTimeout = setTimeout(() => {
                    const opponent = 'Player' + Math.floor(Math.random() * 1000);
                    const code = this.generateRoomCode();
                    
                    this.currentRoom = {
                        code: code,
                        host: this.currentUser.username,
                        players: [this.currentUser.username, opponent],
                        status: 'playing',
                        quickMatch: true
                    };
                    
                    this.isHost = true;
                    this.closeModal('matchmakingModal');
                    this.startMultiplayerGame();
                }, 2000);
            },

            cancelMatchmaking() {
                clearTimeout(this.matchmakingTimeout);
                this.closeModal('matchmakingModal');
            },

            copyRoomCode() {
                navigator.clipboard.writeText(this.currentRoom.code);
                alert('Code copied: ' + this.currentRoom.code);
            },

            shareRoomLink() {
                const url = window.location.origin + window.location.pathname + '?room=' + this.currentRoom.code;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Join my Flip Match game!',
                        text: 'Room Code: ' + this.currentRoom.code,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url);
                    alert('Link copied!\n' + url);
                }
            },

            leaveRoom() {
                clearInterval(this.roomPollInterval);
                this.currentRoom = null;
                this.isHost = false;
                document.getElementById('roomLobby').classList.add('hidden');
                document.getElementById('modeSelection').classList.remove('hidden');
            },

            backToWelcome() {
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            },

            quitToMenu() {
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
                clearInterval(this.roomPollInterval);
                this.currentRoom = null;
                this.isHost = false;
                document.getElementById('gamePlay').classList.add('hidden');
                document.getElementById('roomLobby').classList.add('hidden');
                document.getElementById('modeSelection').classList.remove('hidden');
                game.cleanup();
            },

            shareScore(platform) {
                const score = document.getElementById('displayTotalScore').textContent || 
                             document.getElementById('victoryScore').textContent;
                const text = `üéâ I scored ${score} in Flip Match! Can you beat me?`;
                const url = window.location.href;

                if (platform === 'twitter') {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
                } else if (platform === 'facebook') {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`, '_blank');
                }
            },

            copyScoreLink() {
                const score = document.getElementById('displayTotalScore').textContent || 
                             document.getElementById('victoryScore').textContent;
                const text = `üéâ I scored ${score} in Flip Match! ${window.location.href}`;
                navigator.clipboard.writeText(text);
                alert('Score link copied!');
            },

            shareMultiplayerResult() {
                const text = `üéÆ Just played Flip Match! Room: ${this.currentRoom.code}`;
                const url = window.location.origin + window.location.pathname + '?room=' + this.currentRoom.code;
                
                if (navigator.share) {
                    navigator.share({ title: 'Flip Match Result', text: text, url: url });
                } else {
                    navigator.clipboard.writeText(text + ' ' + url);
                    alert('Result copied!');
                }
            },

            rematch() {
                this.closeModal('multiplayerVictoryModal');
                if (this.currentRoom) {
                    this.currentRoom.status = 'playing';
                    this.startMultiplayerGame();
                }
            },

            filterByMode(mode) {
                this.currentModeFilter = mode;
                document.querySelectorAll('.mode-filter').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                this.loadLeaderboard(this.currentLeaderboard);
            },

            async submitScore(moves, time, level, mode, totalScore) {
                if (!this.currentUser) return;

                try {
                    const scoreKey = 'score:' + mode + ':' + Date.now() + ':' + this.currentUser.username;
                    const scoreData = {
                        username: this.currentUser.username,
                        moves,
                        time,
                        level,
                        mode,
                        totalScore,
                        timestamp: Date.now()
                    };

                    await window.storage.set(scoreKey, JSON.stringify(scoreData), true);

                    const gamesPlayed = await window.storage.get('stats:gamesplayed', true);
                    const count = gamesPlayed ? parseInt(gamesPlayed.value) : 0;
                    await window.storage.set('stats:gamesplayed', (count + 1).toString(), true);

                    if (mode === 'multiplayer') {
                        const multiMatches = await window.storage.get('stats:multimatches', true);
                        const mCount = multiMatches ? parseInt(multiMatches.value) : 0;
                        await window.storage.set('stats:multimatches', (mCount + 1).toString(), true);
                    }
                } catch (error) {}
            },

            async showLeaderboard() {
                await this.loadLeaderboard(this.currentLeaderboard);
                document.getElementById('leaderboardModal').classList.add('active');
            },

            async switchLeaderboard(type) {
                this.currentLeaderboard = type;
                await this.loadLeaderboard(type);
            },

            async loadLeaderboard(type) {
                const listElement = document.getElementById('leaderboardList');
                listElement.innerHTML = '<p style="text-align: center; color: #999;">Loading...</p>';

                try {
                    const scoresList = await window.storage.list('score:', true);
                    
                    if (!scoresList || !scoresList.keys || scoresList.keys.length === 0) {
                        listElement.innerHTML = '<p style="text-align: center; color: #999;">No scores yet!</p>';
                        return;
                    }

                    const scores = [];
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    const oneWeek = 7 * oneDay;

                    for (const key of scoresList.keys) {
                        try {
                            const data = await window.storage.get(key, true);
                            if (data && data.value) {
                                const score = JSON.parse(data.value);
                                
                                if (score.mode && score.mode !== this.currentModeFilter) continue;
                                if (type === 'daily' && now - score.timestamp > oneDay) continue;
                                if (type === 'weekly' && now - score.timestamp > oneWeek) continue;
                                
                                scores.push(score);
                            }
                        } catch (e) {}
                    }

                    scores.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                    const topScores = scores.slice(0, 10);

                    if (topScores.length === 0) {
                        listElement.innerHTML = '<p style="text-align: center; color: #999;">No scores yet!</p>';
                        return;
                    }

                    let html = '';
                    topScores.forEach((score, index) => {
                        const rank = index + 1;
                        let rankClass = '';
                        let medal = '';
                        
                        if (rank === 1) { rankClass = 'gold'; medal = 'ü•á'; }
                        else if (rank === 2) { rankClass = 'silver'; medal = 'ü•à'; }
                        else if (rank === 3) { rankClass = 'bronze'; medal = 'ü•â'; }
                        else { medal = `#${rank}`; }

                        html += `
                            <div class="leaderboard-item">
                                <span class="rank ${rankClass}">${medal}</span>
                                <span class="player-name">${score.username}</span>
                                <span class="score">${score.totalScore || 0} pts ‚Ä¢ Lvl ${score.level || 1}</span>
                            </div>
                        `;
                    });

                    listElement.innerHTML = html;
                } catch (error) {
                    listElement.innerHTML = `
                        <div class="leaderboard-item">
                            <span class="rank gold">ü•á</span>
                            <span class="player-name">Champion</span>
                            <span class="score">5000 pts</span>
                        </div>
                    `;
                }
            },

            async viewStats() {
                await this.updateLiveStats();
                const gridElement = document.getElementById('globalStatsGrid');
                
                gridElement.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${document.getElementById('onlineUsers').textContent}</div>
                        <div class="stat-label">Online Now</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${document.getElementById('totalPlayers').textContent}</div>
                        <div class="stat-label">Total Players</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${document.getElementById('gamesPlayed').textContent}</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${document.getElementById('multiplayerMatches').textContent}</div>
                        <div class="stat-label">Multiplayer</div>
                    </div>
                `;

                document.getElementById('globalStatsModal').classList.add('active');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        };

        // Game Logic
        const game = {
            allEmojis: ['üçé', 'üçå', 'üçá', 'üçä', 'üçì', 'üçí', 'üçë', 'üçâ', 'ü•ù', 'üçç', 'ü•≠', 'üçã', 'ü´ê', 'ü••', 'üçà', 'üçê', 'ü•ë', 'üå∂Ô∏è'],
            
            levels: [
                { pairs: 6, grid: [3, 4], moves: 20, lives: 5 },
                { pairs: 8, grid: [4, 4], moves: 25, lives: 4 },
                { pairs: 10, grid: [4, 5], moves: 30, lives: 3 },
                { pairs: 12, grid: [4, 6], moves: 35, lives: 3 },
                { pairs: 15, grid: [5, 6], moves: 45, lives: 2 },
                { pairs: 18, grid: [6, 6], moves: 55, lives: 1 }
            ],
            
            mode: null,
            currentLevel: 0,
            totalScore: 0,
            flippedCards: [],
            matchedPairs: 0,
            moves: 0,
            movesRemaining: 0,
            lives: 0,
            timer: 0,
            timerInterval: null,
            gameStarted: false,
            isProcessing: false,
            isMultiplayer: false,
            multiplayerRoom: null,
            playerScores: { player1: 0, player2: 0 },
            currentTurn: 0,

            init(mode, isMultiplayer = false, room = null) {
                this.mode = mode;
                this.currentLevel = 0;
                this.totalScore = 0;
                this.isMultiplayer = isMultiplayer;
                this.multiplayerRoom = room;
                this.playerScores = { player1: 0, player2: 0 };
                this.currentTurn = 0;
                this.startLevel();
            },

            startLevel() {
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.moves = 0;
                this.gameStarted = false;
                this.isProcessing = false;
                
                const levelConfig = this.levels[this.currentLevel];
                this.movesRemaining = levelConfig.moves;
                this.lives = levelConfig.lives;
                
                document.getElementById('currentLevel').textContent = this.currentLevel + 1;
                document.getElementById('levelBadge').textContent = `Level ${this.currentLevel + 1}`;
                document.getElementById('totalScore').textContent = this.totalScore;
                document.getElementById('moves').textContent = '0';
                document.getElementById('pairs').textContent = `0/${levelConfig.pairs}`;
                
                if (this.mode === 'hardcore') {
                    document.getElementById('livesBox').style.display = 'block';
                    this.updateLivesDisplay();
                } else {
                    document.getElementById('livesBox').style.display = 'none';
                }

                if (this.mode === 'timed') {
                    document.getElementById('movesBox').querySelector('.info-label').textContent = 'Moves Left';
                    document.getElementById('moves').textContent = this.movesRemaining;
                } else {
                    document.getElementById('movesBox').querySelector('.info-label').textContent = 'Moves';
                }
                
                this.stopTimer();
                this.timer = 0;
                document.getElementById('timer').textContent = '0:00';
                
                this.createBoard(levelConfig);
            },

            createBoard(config) {
                const board = document.getElementById('gameBoard');
                board.innerHTML = '';
                board.style.gridTemplateColumns = `repeat(${config.grid[0]}, 1fr)`;
                
                const levelCards = this.allEmojis.slice(0, config.pairs);
                const cardPairs = [...levelCards, ...levelCards];
                const shuffled = this.shuffle(cardPairs);

                shuffled.forEach((emoji, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.emoji = emoji;
                    card.dataset.index = index;
                    
                    card.innerHTML = `
                        <div class="card-face card-back">?</div>
                        <div class="card-face card-front">${emoji}</div>
                    `;
                    
                    card.addEventListener('click', () => this.flipCard(card));
                    board.appendChild(card);
                });
            },

            shuffle(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            },

            flipCard(card) {
                if (this.isProcessing || 
                    card.classList.contains('flipped') || 
                    card.classList.contains('matched') ||
                    this.flippedCards.length >= 2) {
                    return;
                }

                if (!this.gameStarted) {
                    this.startTimer();
                    this.gameStarted = true;
                }

                card.classList.add('flipped');
                this.flippedCards.push(card);

                if (this.flippedCards.length === 2) {
                    this.moves++;
                    
                    if (this.mode === 'timed') {
                        this.movesRemaining--;
                        document.getElementById('moves').textContent = this.movesRemaining;
                        
                        if (this.movesRemaining <= 0) {
                            setTimeout(() => this.gameOver('Out of moves!'), 600);
                            return;
                        }
                    } else {
                        document.getElementById('moves').textContent = this.moves;
                    }
                    
                    this.checkMatch();
                }
            },

            checkMatch() {
                this.isProcessing = true;
                const [card1, card2] = this.flippedCards;
                const levelConfig = this.levels[this.currentLevel];
                
                if (card1.dataset.emoji === card2.dataset.emoji) {
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        this.matchedPairs++;
                        
                        if (this.isMultiplayer) {
                            if (this.currentTurn === 0) {
                                this.playerScores.player1++;
                                document.getElementById('player1Score').textContent = this.playerScores.player1;
                            } else {
                                this.playerScores.player2++;
                                document.getElementById('player2Score').textContent = this.playerScores.player2;
                            }
                        }
                        
                        document.getElementById('pairs').textContent = `${this.matchedPairs}/${levelConfig.pairs}`;
                        this.flippedCards = [];
                        this.isProcessing = false;

                        if (this.matchedPairs === levelConfig.pairs) {
                            if (this.isMultiplayer) {
                                this.multiplayerComplete();
                            } else {
                                this.levelComplete();
                            }
                        }
                    }, 600);
                } else {
                    setTimeout(() => {
                        if (this.mode === 'hardcore') {
                            this.lives--;
                            this.updateLivesDisplay();
                            
                            if (this.lives <= 0) {
                                card1.classList.remove('flipped');
                                card2.classList.remove('flipped');
                                this.flippedCards = [];
                                this.isProcessing = false;
                                this.gameOver('Out of lives!');
                                return;
                            }
                        }
                        
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        this.flippedCards = [];
                        this.isProcessing = false;
                        
                        if (this.isMultiplayer) {
                            this.currentTurn = 1 - this.currentTurn;
                        }
                    }, 1000);
                }
            },

            updateLivesDisplay() {
                const hearts = '‚ù§Ô∏è'.repeat(this.lives) + 'üñ§'.repeat(this.levels[this.currentLevel].lives - this.lives);
                document.getElementById('lives').textContent = hearts;
            },

            levelComplete() {
                this.stopTimer();
                
                const levelTime = this.timer;
                let levelScore = 1000;
                
                const timeBonus = Math.max(0, 500 - (levelTime * 5));
                levelScore += Math.floor(timeBonus);
                
                if (this.mode === 'classic') {
                    const moveBonus = Math.max(0, 300 - (this.moves * 10));
                    levelScore += Math.floor(moveBonus);
                } else if (this.mode === 'timed') {
                    levelScore += this.movesRemaining * 50;
                } else if (this.mode === 'hardcore') {
                    levelScore += this.lives * 200;
                }
                
                this.totalScore += levelScore;
                
                const minutes = Math.floor(levelTime / 60);
                const seconds = levelTime % 60;
                
                document.getElementById('completedLevel').textContent = this.currentLevel + 1;
                document.getElementById('finalMoves').textContent = this.moves;
                document.getElementById('finalTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('levelScore').textContent = levelScore;
                document.getElementById('displayTotalScore').textContent = this.totalScore;
                
                document.getElementById('winModal').classList.add('active');
            },

            multiplayerComplete() {
                this.stopTimer();
                
                const winner = this.playerScores.player1 > this.playerScores.player2 ? 0 : 1;
                const isWinner = winner === 0 && app.currentUser.username === app.currentRoom.players[0] ||
                                winner === 1 && app.currentUser.username === app.currentRoom.players[1];
                
                document.getElementById('multiWinTitle').textContent = isWinner ? 'üèÜ You Win!' : 'üò¢ You Lost!';
                document.getElementById('finalPlayer1Name').textContent = app.currentRoom.players[0];
                document.getElementById('finalPlayer2Name').textContent = app.currentRoom.players[1];
                document.getElementById('finalPlayer1Score').textContent = this.playerScores.player1;
                document.getElementById('finalPlayer2Score').textContent = this.playerScores.player2;
                
                if (winner === 0) {
                    document.getElementById('finalPlayer1Card').classList.add('winner');
                } else {
                    document.getElementById('finalPlayer2Card').classList.add('winner');
                }
                
                app.submitScore(this.moves, this.timer, this.currentLevel + 1, 'multiplayer', this.totalScore);
                
                document.getElementById('multiplayerVictoryModal').classList.add('active');
            },

            nextLevel() {
                document.getElementById('winModal').classList.remove('active');
                this.currentLevel++;
                
                if (this.currentLevel >= this.levels.length) {
                    this.allLevelsComplete();
                } else {
                    this.startLevel();
                }
            },

            allLevelsComplete() {
                this.stopTimer();
                
                const totalMinutes = Math.floor(this.timer / 60);
                const totalSeconds = this.timer % 60;
                
                document.getElementById('victoryScore').textContent = this.totalScore;
                document.getElementById('victoryTime').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                document.getElementById('victoryMoves').textContent = this.moves;
                
                app.submitScore(this.moves, this.timer, this.currentLevel, this.mode, this.totalScore);
                
                document.getElementById('victoryModal').classList.add('active');
            },

            gameOver(reason) {
                this.stopTimer();
                
                document.getElementById('gameOverReason').textContent = reason;
                document.getElementById('finalLevel').textContent = this.currentLevel + 1;
                document.getElementById('gameOverScore').textContent = this.totalScore;
                
                app.submitScore(this.moves, this.timer, this.currentLevel + 1, this.mode, this.totalScore);
                
                document.getElementById('gameOverModal').classList.add('active');
            },

            retryLevel() {
                document.getElementById('gameOverModal').classList.remove('active');
                this.startLevel();
            },

            restartLevel() {
                if (confirm('Restart level? Progress will be lost.')) {
                    this.startLevel();
                }
            },

            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    const minutes = Math.floor(this.timer / 60);
                    const seconds = this.timer % 60;
                    document.getElementById('timer').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            },

            stopTimer() {
                clearInterval(this.timerInterval);
            },

            cleanup() {
                this.stopTimer();
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.moves = 0;
                this.timer = 0;
                this.gameStarted = false;
                this.isProcessing = false;
                this.currentLevel = 0;
                this.totalScore = 0;
                this.isMultiplayer = false;
                this.multiplayerRoom = null;
                this.playerScores = { player1: 0, player2: 0 };
            }
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
